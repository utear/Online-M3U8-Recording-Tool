# 视频流录制工具

基于 [N_m3u8DL-RE](https://github.com/nilaoda/N_m3u8DL-RE) 的网页版视频流录制工具，提供友好的用户界面来管理视频流（M3U/M3U8等）的录制任务。

在此对项目原作者nilaoda大佬表示衷心的感谢。

## 系统要求

- Node.js 16+
- N_m3u8DL-RE 可执行文件

## 主要功能

- 支持录制 m3u/m3u8/视频流
- 多任务并行录制，实时显示进度
- 批量录制功能，支持同时启动多个录制任务
- 任务组管理，支持批量停止和控制
- 可配置下载参数（线程数、保存目录等）
- 内置进程控制终端，支持实时交互（可能存在bug）
- 完整的文件管理机制
- IPTV直播列表自动更新机制：
  - 服务器端每4小时自动更新一次IPTV列表
  - 本地缓存支持，减少网络请求
  - 支持HTTP代理配置，解决GitHub访问问题
  - 默认IPTV源：https://github.com/vbskycn/iptv/blob/master/tv/iptv4.m3u
- 用户权限管理系统：
  - 支持用户注册和登录
  - 基于JWT的安全认证机制
  - 管理员账户功能：
    * 管理员仪表盘，实时监控系统状态
    * 用户管理，支持用户的增删改查操作
    * 任务监控，查看所有用户的任务记录
    * 任务管理，支持任务的停止、删除和下载
    * 文件管理，支持下载文件和临时文件的管理
    * 系统设置，包括IPTV源配置和存储设置
    * 统计数据查看，用户数、活跃任务数等
  - 普通用户功能：
    * 创建和管理自己的录制任务
    * 实时查看任务进度
    * 下载已完成的录制文件
- 文件下载功能：
  - 支持大文件下载
  - 实时显示下载进度
  - 基于用户权限的访问控制
  - 自动文件完整性检查

## 图片演示
![image](https://github.com/user-attachments/assets/e131c55d-2611-4061-bdd3-bae8d147941c)
![image](https://github.com/user-attachments/assets/a629356c-7a28-43c4-a00e-37e466eed950)
![image](https://github.com/user-attachments/assets/377f3941-fd94-4f3a-ab57-c609ccf03958)
![image](https://github.com/user-attachments/assets/1508b9f2-96c4-4095-9a1b-70b26dc76dac)
![image](https://github.com/user-attachments/assets/2b3d35df-bb2e-4305-a617-561c58b76c92)
![image](https://github.com/user-attachments/assets/d2ae4876-8b9e-4374-8cc9-52290e65b432)
![image](https://github.com/user-attachments/assets/ee183707-6057-408b-ab8f-671fe79b3908)
![image](https://github.com/user-attachments/assets/ab5c9fe9-9317-41c8-bf02-1036cd36540f)

## 快速开始

### 一键部署（推荐）

1. 克隆项目：
```bash
git clone https://github.com/Asheblog/N_m3u8DL-RE-web.git
cd N_m3u8DL-RE-web
```

2. 运行一键部署脚本：
```bash
# Windows系统
node setup.js

# Linux/macOS系统
chmod +x setup.js
./setup.js
```

3. 按照提示进行配置：
   - 设置管理员账户名和密码
   - 配置端口信息
   - 下载N_m3u8DL-RE可执行文件（如果尚未下载）
   - 自动安装前后端依赖
   - 自动创建必要的目录和配置文件
   - 启动服务

4. 访问：`http://本机IP:前端端口号`

### 一键启动（已部署后使用）

如果您已经完成了项目部署，可以使用一键启动脚本快速启动前后端服务：

```bash
# Windows系统
node start.js

# Linux/macOS系统
chmod +x start.js
./start.js
```

一键启动脚本会自动：
- 检查环境配置和必要文件
- 创建默认配置文件（如果不存在）
- 启动后端服务
- 启动前端服务
- 显示访问地址

启动完成后，只需在浏览器中访问提示的地址即可使用系统。按下`Ctrl+C`可以停止所有服务。

### 手动安装

1. 克隆项目：
```bash
git clone https://github.com/Asheblog/N_m3u8DL-RE-web.git
```

2. 安装依赖：
```bash
# 后端
cd backend
npm install

# 前端
cd ../frontend
npm install
```

3. 确保 N_m3u8DL-RE 可执行文件 (Sever.exe) 位于项目根目录

### 环境配置

在启动前，需要配置环境变量：

1. 后端配置 (`backend/.env`):
```bash
PORT=3001
HOST=0.0.0.0  # 使用 0.0.0.0 允许外部访问
WS_PORT=3002  # WebSocket服务端口
JWT_SECRET=your-secret-key  # JWT密钥，请修改为随机字符串
TOKEN_EXPIRE=24h  # Token过期时间

# CORS配置，指定允许访问的源（域名），多个源用逗号分隔
CORS_ALLOWED_ORIGINS=http://localhost:3005,http://your-domain.com:3005
```

2. 前端配置 (`frontend/.env`):
```bash
# 前端访问地址和端口配置
VITE_HOST=0.0.0.0  # 允许外部访问
VITE_PORT=3005     # 前端服务端口

# API 接口配置（根据实际部署环境修改）
VITE_API_BASE_URL=http://your-server-ip:3001  # 替换为实际的服务器地址
VITE_WS_URL=ws://your-server-ip:3002          # 替换为实际的服务器地址

# 允许访问的主机配置（解决生产环境跨域问题）
VITE_ALLOWED_HOSTS=your-domain.com,www.your-domain.com  # 多个域名用逗号分隔
```

3. HTTP代理配置（如果需要）:
在 `backend/services/iptvService.js` 中配置代理设置：
```javascript
const PROXY_CONFIG = {
    host: '127.0.0.1',  // 代理服务器地址
    port: 7890          // 代理服务器端口
};
```

注意：
- 开发环境可使用 localhost
- 生产环境请替换为实际的服务器IP或域名
- 如果服务器无法直接访问GitHub，请配置HTTP代理
- 在生产环境中，需要在 `VITE_ALLOWED_HOSTS` 中配置允许访问的域名，以解决跨域访问限制问题

### 启动

1. 启动后端服务：
```bash
cd backend
node server.js
```

2. 启动前端服务：
```bash
cd frontend
npm run dev
```

3. 访问：`http://localhost:你设定的前端端口号`

### 管理员账户设置

1. 初始化管理员账户：
```bash
cd backend
node scripts/init-admin.js
```
这将创建默认管理员账户：
- 用户名：admin
- 密码：admin123

你可以通过修改 `backend/scripts/init-admin.js` 文件来自定义管理员账户：
```javascript
const adminUser = {
    username: 'admin',  // 修改管理员用户名
    password: 'admin123',  // 修改管理员密码
    role: 'admin'  // 不要修改此项
};
```

注意：请在首次使用时立即修改默认密码，以确保系统安全。

## 使用指南

### 录制任务

1. 在"新建录制任务"中输入视频流地址
2. 配置必要参数（保存目录、线程数等）
3. 点击"开始录制"

### 任务管理

- 查看任务状态和进度
- 打开控制台查看详细信息
- 停止/删除任务
- 下载已完成的录制文件

## 目录结构

```
.
├── backend/           # 后端代码
│   ├── downloads/    # 下载文件目录
│   ├── temp/        # 临时文件目录
│   └── server.js    # 后端主程序
├── frontend/        # 前端代码
└── Sever.exe       # N_m3u8DL-RE 程序
```

## 更新日志

### 2025-04-20（19:35）

- **仪表盘文件管理功能**
  - 添加了下载文件目录管理功能，支持查看、删除和搜索文件
  - 添加了临时文件目录管理功能，支持清理临时文件
  - 实现了批量删除功能，支持选择多个文件/文件夹进行删除
  - 添加了一键清理所有非活跃任务的临时文件功能
  - 显示文件大小、创建时间和修改时间等详细信息
  - 支持按文件名、大小和时间排序
  - 临时文件管理支持显示关联的任务信息

### 2025-04-20（18:44）

- **日志输出优化**
  - 注释了CORS相关的日志输出，减少日志干扰
  - 优化了日志输出策略，使重要日志更易于查看
  - 注释了OPTIONS预检请求的日志输出，减少日志干扰

- **任务删除功能完善**
  - 修复了删除任务时后端日志不输出的问题
  - 发现并修复了路由冲突问题，确保删除请求被正确处理
  - 完善了临时目录和输出文件的删除逻辑
  - 添加了详细的日志输出，包括请求头、文件存在性检查等
  - 增强了命令行删除工具的事件监听，跟踪删除过程

### 2025-04-22（18:00）

- **批量录制页面布局优化**
  - 优化了批量录制页面的表单布局，使其更加紧凑
  - 采用与单个录制页面相同的网格布局，提高了页面空间利用率
  - 改进了表单项的分类显示，使界面更加清晰
  - 保持了所有功能不变，仅优化了视觉呈现

### 2025-04-20（17:09）

- **临时文件管理优化**
  - 添加了临时目录路径存储功能，确保准确删除临时文件
  - 优化了单个任务删除时的临时目录删除逻辑
  - 为批量任务组删除功能添加了临时目录删除逻辑
  - 修复了文件大小显示问题，使用正确的SQLite API更新文件大小
  - 添加了数据库字段升级脚本，支持临时目录路径存储

### 2025-04-20（16:37）

- **优化CORS跨域处理**
  - 重构用户登录模块，简化CORS中间件并移除重复配置
  - 添加SIMPLE_CORS环境变量选项，允许快速切换到简化模式
  - 优化前端登录和注册组件请求方式，简化axios配置

- **增强日志记录与错误处理**
  - 增强后端路由处理，添加详细的日志记录
  - 更新setup.js脚本，增强CORS配置选项
  - 优化错误处理机制，提供更清晰的错误提示

- **改进前端请求机制**
  - 重构前端登录和注册组件，添加多重备用请求机制
  - 优化登录和注册组件，使用完整URL进行请求
  - 创建自定义axios实例，提供更灵活的请求配置

- **优化后端CORS配置**
  - 重构CORS中间件，采用更直接的方式设置头部
  - 增强OPTIONS预检请求处理，添加相关头部减少预检请求频率
  - 优化后端服务器CORS配置，提供双重保障

- **提升调试与部署体验**
  - 添加详细的请求头部日志和请求日志，便于调试
  - 更新一键部署脚本，增强CORS配置的生成逻辑
  - 优化域名处理逻辑，确保正确生成协议URL

### 2025-04-20
**批量任务组一键删除功能**：
- 添加了批量任务组一键删除功能，即使任务都已被单独删除，也可以清理任务组
- 实现了后端删除任务组及其关联任务的接口
- 在前端批量任务组面板添加了删除按钮
- 删除前增加了确认对话框防止误操作
- 优化了删除流程，先停止运行中的任务再删除相关记录

**批量录制控制台输出修复**：
- 修复了批量录制任务控制台显示空白的问题
- 添加了任务输出历史记录保存功能，确保批量任务也能正确显示控制台输出
- 将批量任务输出同步到WebSocket消息缓冲区，确保实时更新
- 补充了文件大小和保存文件名的解析逻辑，与单个录制任务保持一致
- 优化了错误处理，确保错误信息也能正确显示在控制台中
- 修复了"Cannot read properties of undefined (reading 'has')"错误，确保messageBuffer是全局可用的
- 增加了全局变量检查，提高了代码健壮性
- 完善了任务结束处理逻辑，确保状态正确更新和文件信息处理

**IPTV批量录制地址丢失问题修复**：
- 修复了从IPTV直播选择批量录制后，地址在2-3秒后自动消失的问题
- 优化了表单状态同步机制，使用React状态和form API直接设置表单值
- 添加了定时器保持表单值稳定，避免数据丢失
- 减少了服务器端消息批处理间隔从200ms到100ms，提高实时响应性
- 增强了批量录制组件的表单值监听，确保数据持久保存
- 修复"请至少输入一个URL"错误提示问题，即使已经输入了URL也会提示的问题
- 添加全局事件通信机制，确保组件间数据同步更加可靠
- 优化按钮禁用逻辑，同时检查状态数组和表单值

**性能优化与内存泄漏修复**：
- 修复了访问主页时Chrome浏览器内存占用飙升并卡死的问题
- 优化了WebSocket连接管理，解决了客户端重复连接的问题
- 添加了指数退避重连策略，减少网络资源消耗
- 优化了终端输出处理逻辑，限制了输出历史大小
- 优化了Token刷新逻辑，减少了不必要的API调用
- 改进了SelectionHelper组件，提高了其性能和稳定性

**批量任务功能修复**：
- 修复了批量任务功能中的数据库问题，解决了"no such column: groupId"错误
- 修复了任务组详情获取失败的问题
- 修复了停止任务组失败的问题
- 确保批量录制功能正常工作

**IPTV直播批量录制优化**：
- 修复了IPTV直播页面选择频道后无法正确导入到批量录制页面的问题
- 实现了页面间的自动切换和数据传递
- 优化了批量录制表单的数据同步机制
- 改进了用户体验，使得从频道列表选择到开始录制的流程更加流畅

**IPTV频道搜索功能**：
- 在批量选择对话框中添加了频道搜索功能
- 支持按频道名称和分组进行搜索过滤
- 优化了全选功能，只选择当前过滤后的频道
- 改进了全选复选框的状态显示逻辑，更符合用户使用习惯

**IPTV直播批量录制增强**：
- 在IPTV直播页面添加了单个/批量录制模式切换
- 支持从频道列表中选择多个频道进行批量录制
- 添加了频道批量选择对话框，支持全选和单选
- 优化了批量录制参数配置，与单个录制保持一致

**批量录制功能**：
- 添加了批量录制功能，支持同时启动多个录制任务
- 实现了任务组管理，支持批量停止和控制
- 添加了任务组列表和详情页面，方便管理批量任务
- 优化了用户界面，使用选项卡分离单个录制和批量录制功能
- 添加了批量任务预览功能，提高用户体验

### 2025-04-17
**终端交互功能增强**：（实验性，未经测试）
- 添加了自动识别选择菜单功能，当检测到"请选择"类提示时自动显示更友好的UI界面
- 支持通过键盘快捷键直接选择菜单项，无需手动输入
- 支持点击按钮选择菜单项，提高用户体验
- 优化了终端输出显示，增强了交互体验
- 重构了终端输入处理逻辑，提高了稳定性

### 2025-04-16
**仪表盘和任务管理自动刷新功能**：
- 添加了仪表盘自动刷新功能，每10秒自动更新统计数据和最新任务列表
- 添加了任务管理页面的自动刷新功能，实时显示任务状态变化
- 修复了仪表盘统计数据不准确的问题，正确显示活跃下载和已完成任务数量
- 优化了用户界面，增加了自动刷新提示，提升用户体验
- 完善了导航功能，添加了Logo和返回首页的快捷链接

**仪表盘数据库架构重构**：
- 将用户数据库与任务数据库分离，使用独立的 users.db 和 tasks.db
- 重构了用户路由和仪表盘路由，使其正确连接到各自的数据库
- 优化了数据库查询逻辑，提高了系统性能和稳定性
- 添加了详细的日志输出，便于调试和问题跟踪

### 2025-04-15
**仪表盘功能全面完善**：
- 完成了用户管理功能，支持用户的增删改查操作
- 完成了任务管理功能，支持任务的停止、删除、查看详情和下载文件
- 完成了系统设置功能，支持IPTV源配置、存储设置和系统参数设置
- 添加了管理员权限验证机制，确保只有管理员可以访问仪表盘
- 优化了用户界面，提供了更好的交互体验

### 2025-04-14
**仪表盘功能完善**：
- 完成了管理员仪表盘的基础功能开发
- 添加了统计数据展示，包括用户数、活跃任务数、已完成任务数和存储使用情况
- 实现了最近任务列表展示
- 添加了用户管理、任务管理和系统设置的占位页面
- 完善了管理员路由权限验证

### 2025-04-04
1.**认证系统重构**：
   - 将原来基于MongoDB/Mongoose的认证系统改为使用SQLite数据库
   - 修改了auth.js路由，使其使用userDb.js中的函数而不是Mongoose模型
   - 在server.js中正确导入和使用auth.js路由模块
   - 简化了用户注册和登录流程，移除了email字段和一些不必要的状态检查

2.**前端配置优化**：
   - 添加了VITE_ALLOWED_HOSTS环境变量，支持动态配置允许访问的域名
   - 在vite.config.js中使用该环境变量配置allowedHosts
   - 更新了README.md，添加了关于新环境变量的说明和使用方法

3.**其他小改动**：
   - 修复了一些格式问题（空格、换行等）

## 已知问题

 - 源程序有支持相关交互选择功能，网页版已实现终端交互选择功能，支持通过键盘快捷键或点击按钮进行选择。
 - 大部分可选命令我暂时用不上，没有条件测试，可能存在BUG。
 - 该项目只是提供了一个相对便捷的网页版ui供大家方便使用，如涉及到源程序N_m3u8DL-RE（https://github.com/nilaoda/N_m3u8DL-RE） 的问题，请到源项目提出相关issue。
 - 后台仪表盘功能已全面完善：
   * 统计面板：显示用户数量、活跃任务数、已完成任务数和存储使用情况
   * 用户管理：查看所有用户、添加/删除用户、修改用户权限
   * 任务管理：查看所有任务、停止运行中任务、删除任务、下载已完成文件
   * 文件管理：查看和管理下载文件和临时文件、批量删除文件、一键清理临时文件
   * 系统设置：配置IPTV源、设置存储路径、管理系统参数
   * 自动刷新：每10秒自动更新统计数据和任务状态
   * 权限控制：只有管理员可访问仪表盘功能
 - 在使用过程中如遇到性能问题，可尝试清除浏览器缓存或重启服务。最新版本已优化WebSocket连接和内存管理，显著提高了稳定性。
 - 本项目作者并不会编程，是通过windsurf+claude并用自然语言交流完成的本项目开发，如在部署过程中有问题或使用过程中存在问题，请自行分析日志解决，日志部分可在/logs目录下查看（仅显示录制过程日志），开发这个项目的初衷也是为了满足作者自身需求。

## 许可证

MIT
