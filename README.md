# 视频流录制工具

这是一个基于 N_m3u8DL-RE（https://github.com/nilaoda/N_m3u8DL-RE） 的网页版视频流录制工具，提供了友好的用户界面来管理视频流的录制任务。

## 功能特点

- 支持录制 m3u/m3u8/视频流
- 实时显示录制进度
- 支持多任务并行录制
- 可配置下载线程数
- 可自定义保存目录
- 支持停止正在进行的录制任务
- 内置进程控制终端，支持实时交互
- 支持多任务终端独立显示和控制
- 完整的文件清理机制，删除任务时自动清理相关文件
  - 自动删除下载目录中的视频文件
  - 自动清理临时文件夹
  - 保留详细的删除操作日志

## 系统要求

- Node.js 16+
- N_m3u8DL-RE 可执行文件

## 安装步骤

1. 克隆项目到本地：

```bash
git clone <repository-url>
```

2. 安装后端依赖：

```bash
cd backend
npm install
```

3. 安装前端依赖：

```bash
cd ../frontend
npm install
```

4. 确保 N_m3u8DL-RE 可执行文件 (Sever.exe) 位于项目根目录。

## 启动应用

1. 启动后端服务器：

```bash
cd backend
node server.js
```

2. 启动前端开发服务器：

```bash
cd frontend
npm run dev
```

3. 在浏览器中访问：`http://localhost:5173`

## 使用说明

### 基本操作
1. 在"新建录制任务"卡片中输入视频流地址 (对应参数 `<input>`: 链接或文件)
2. 可选择配置以下参数:
   - 保存目录 (对应参数 `--save-dir`): 设置下载文件的输出目录，默认为 `./downloads`
   - 下载线程数 (对应参数 `--thread-count`): 设置下载的并发线程数，默认为本机 CPU 线程数
   - 临时文件目录 (对应参数 `--tmp-dir`): 设置临时文件的存储位置
   - 文件名 (对应参数 `--save-name`): 设置保存的文件名
   - 录制时长限制 (对应参数 `--live-record-limit`): 设置直播录制的时长限制，格式为 HH:mm:ss
   - 实时合并 (对应参数 `--live-real-time-merge`): 是否在录制直播时实时合并分片，默认为 false
   - 保留分片 (对应参数 `--live-keep-segments`): 开启实时合并时是否保留原始分片，默认为 true
   - 下载重试次数 (对应参数 `--download-retry-count`): 分片下载失败时的重试次数，默认为 3
   - 请求超时时间 (对应参数 `--http-request-timeout`): HTTP 请求的超时时间(秒)，默认为 100
3. 点击"开始录制"按钮开始任务

### 任务管理
1. 在任务列表中可以查看所有任务的状态和进度
2. 对于运行中的任务：
   - 点击"打开控制台"按钮可以打开进程控制终端
   - 点击"停止"按钮可以停止录制任务
3. 任务完成后可以点击"下载"按钮获取录制文件

### 终端控制
1. 每个任务都有独立的终端窗口，互不干扰
2. 终端窗口功能：
   - 实时显示任务的输出信息
   - 支持输入命令与进程交互
   - 可以同时打开多个终端窗口
   - 支持终端输出自动滚动
   - 支持复制粘贴操作
3. 终端窗口操作：
   - 打开：点击任务的"打开控制台"按钮
   - 关闭：点击终端窗口右上角的关闭按钮
   - 输入：在底部输入框中输入命令，按回车发送
   - 关闭终端窗口不会影响任务的运行
   - 可以随时重新打开终端窗口查看任务状态

## 目录结构

```
.
├── backend/                # 后端代码
│   ├── downloads/         # 下载的视频文件存储目录
│   ├── temp/             # 临时文件目录
│   ├── data/             # 数据库和配置文件目录
│   └── server.js         # 后端主程序
├── frontend/             # 前端代码
└── Sever.exe            # N_m3u8DL-RE 可执行文件
```

## 文件管理

### 文件存储
- 视频文件保存在 `backend/downloads` 目录
- 临时文件存储在 `backend/temp` 目录下的独立文件夹中
- 每个录制任务的文件名格式为：`频道名_年-月-日_时-分-秒.ts`
- 临时文件夹名与视频文件名相同（不含扩展名）

### 文件清理
- 删除任务时会自动清理相关文件：
  1. 删除 downloads 目录中的视频文件
  2. 删除对应的临时文件夹
  3. 清理数据库中的任务记录
- 删除操作会记录详细日志，包括：
  - 删除开始时间
  - 文件路径信息
  - 删除结果
  - 可能的错误信息

## 参数说明

所有的开关参数（布尔值选项）都需要明确指定其值：

```bash
# 正确的用法
--del-after-done true    # 下载完成后删除临时文件
--del-after-done false   # 下载完成后保留临时文件

--use-system-proxy true  # 使用系统代理
--use-system-proxy false # 不使用系统代理

# 其他常见开关参数示例
--append-url-params true      # 将URL参数添加到分片
--live-real-time-merge true  # 直播实时合并
--check-segments-count true  # 检查分片数量
--write-meta-json true      # 输出JSON元数据
```

注意：
1. 所有布尔值选项都必须明确指定 `true` 或 `false`
2. 不支持省略值的形式（如 `--del-after-done` 这样的用法是错误的）
3. 不支持使用 `--no-` 或 `--disable-` 等前缀

## 注意事项

- 默认保存目录为 `./downloads`
- 默认临时文件目录为 `./temp`
- 支持设置自定义保存目录和临时目录，可以使用相对路径或绝对路径
- 录制直播时建议开启 `--live-real-time-merge true` 选项
- 建议根据网络状况选择合适的下载线程数
- 停止任务后，已下载的部分会被保留

## 最近更新

### 2025-01-01
1. WebSocket连接优化
   - 改进了WebSocket连接管理，提高了连接稳定性
   - 实现了客户端主动心跳机制，减少断连情况
   - 优化了重连逻辑，避免重复连接
   - 改进了错误处理和资源清理

2. 终端显示改进
   - 优化了终端输出更新逻辑，提高实时性
   - 改进了多终端管理，避免相互干扰
   - 优化了终端状态同步机制

3. 删除任务功能修复
   - 修复了删除任务时出现404错误的问题
   - 完善了任务删除的数据清理逻辑
   - 添加了相关文件的自动清理

4. 性能优化
   - 减少了不必要的状态更新和重渲染
   - 优化了WebSocket消息处理
   - 改进了数据库操作的异步处理
   - 优化了终端输出处理，避免重复显示相同的输出内容

5. 历史记录功能改进
   - 修复了历史按钮点击无响应的问题
   - 优化了历史记录的展示界面
   - 添加了时间戳显示
   - 改进了历史记录的错误处理
   - 支持滚动查看长内容

### 功能说明

#### 历史记录查看
1. 在任务列表中点击"历史"按钮可以查看任务的历史记录
2. 历史记录包含：
   - 执行时间戳
   - 详细的输出内容
3. 支持功能：
   - 按时间顺序展示所有历史记录
   - 滚动查看长内容
   - 自动格式化时间显示
   - 支持关闭和重新打开

## 更新日志

### 2025-01-07
- 修复了终端输出重复显示的问题
  - 在处理 WebSocket 'progress' 消息时添加了重复检查逻辑
  - 只有当新输出内容与最后一行不同时才更新终端显示
  - 保持了实时更新功能的同时避免了重复输出

### 2025-01-01
- 优化了控制台实时输出功能
  - 改进了 WebSocket 消息处理机制
  - 实现了终端输出的实时更新
  - 优化了状态管理和渲染逻辑

### 2024-12-31
- 新增多任务终端支持
  - 支持每个任务独立的终端窗口
  - 实现终端输出的独立显示和滚动
  - 添加任务的订阅/取消订阅机制
  - 优化终端界面的交互体验
  - 支持多任务并行控制
- 新增进程控制终端功能
  - 添加了实时进程输出显示
  - 支持直接输入命令与进程交互
  - 优化了终端界面样式
  - 添加了自动滚动和复制粘贴支持
- 修复了录制完成后无法显示下载按钮的问题
  - 优化了任务状态判断逻辑，现在只要进程正常退出（退出码为0）就认为任务成功完成
  - 添加了从程序输出中提取实际保存文件名的功能
  - 实时更新任务的输出文件路径
  - 增加了更多调试信息，包括：
    - 检查文件是否存在
    - 列出保存目录中的文件
    - 显示实际的文件路径和大小

### 已知问题
- 如果录制过程中断，可能会导致文件保存不完整
- 某些特殊字符在文件名中可能会导致保存失败

### 注意事项
- 录制完成后，文件会保存在 `downloads` 目录中
- 实际的文件名格式为：`[直播ID]_[日期]_[时间].ts`
- 建议定期清理 `downloads` 目录，以免占用过多磁盘空间

## 技术栈

- 前端：React + Ant Design + Vite
- 后端：Node.js + Express
- 实时通信：WebSocket
- 核心功能：N_m3u8DL-RE